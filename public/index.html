<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>𝐂𝐚𝐥𝐲𝐱 𝐃𝐫𝐞𝐲 𝐋𝐢𝐯𝐞 𝐂𝐡𝐚𝐭 </title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --my-message-color: #3B82F6;
            --other-message-color: #374151;
            --system-message-color: #4a4a4a;
            --text-color: #e0e0e0;
            --text-secondary-color: #a0a0a0;
            --chat-window-bg: #242424;
            --card-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            --error-color: #ef4444;
            --delete-color: #dc2626;
            --reply-color: #16a34a;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Poppins', sans-serif; background-color: var(--bg-color); color: var(--text-color); display: flex; justify-content: center; align-items: center; height: 100vh; padding: 1rem; overflow: hidden; }

        /* --- Welcome Screen --- */
        #welcome-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.8); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .welcome-box { background-color: var(--surface-color); padding: 2rem; border-radius: 16px; text-align: center; box-shadow: var(--card-shadow); width: 90%; max-width: 400px; }
        .welcome-box h2 { margin-bottom: 0.5rem; }
        .welcome-box p { color: var(--text-secondary-color); margin-bottom: 1.5rem; }
        #join-form input { width: 100%; padding: 0.75rem 1rem; font-size: 1rem; border-radius: 20px; border: 2px solid var(--chat-window-bg); background-color: var(--chat-window-bg); color: var(--text-color); margin-bottom: 1rem; }
        #join-form input:focus { outline: none; border-color: var(--my-message-color); }
        #join-form button { width: 100%; padding: 0.75rem; background-color: var(--my-message-color); color: white; border: none; border-radius: 20px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: background-color 0.2s; }
        #join-form button:hover { background-color: #2563EB; }
        #join-error-msg { color: var(--error-color); height: 20px; margin-top: 0.5rem; }

        /* --- Chat Container --- */
        .chat-container { display: none; width: 100%; max-width: 700px; height: 90vh; max-height: 800px; background-color: var(--surface-color); border-radius: 16px; box-shadow: var(--card-shadow); flex-direction: column; overflow: hidden; }
        header { padding: 1rem; text-align: center; border-bottom: 1px solid #333; flex-shrink: 0; }
        header h1 { font-size: 1.5rem; }
        header .status-bar { font-size: 0.9rem; color: var(--text-secondary-color); margin-top: 4px; }
        header .status-bar a { color: var(--my-message-color); text-decoration: none; }
        #user-list { font-size: 0.8rem; margin-top: 8px; max-width: 100%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- Chat Window & Messages --- */
        #chat-window { flex-grow: 1; padding: 1rem; overflow-y: auto; display: flex; flex-direction: column; gap: 0.5rem; }
        #chat-window::-webkit-scrollbar { width: 8px; }
        #chat-window::-webkit-scrollbar-track { background: var(--surface-color); }
        #chat-window::-webkit-scrollbar-thumb { background-color: var(--chat-window-bg); border-radius: 4px; }
        
        .message-swipe-container { position: relative; overflow: hidden; border-radius: 20px; }
        .swipe-background { position: absolute; top: 0; bottom: 0; width: 100%; display: flex; align-items: center; color: white; font-size: 1.5rem; }
        .swipe-background.left { left: 0; justify-content: flex-start; background: var(--delete-color); }
        .swipe-background.right { right: 0; justify-content: flex-end; background: var(--reply-color); }
        .swipe-background i { margin: 0 20px; }
        
        .message-wrapper { display: flex; flex-direction: column; max-width: 75%; padding: 0.5rem; transition: transform 0.2s ease-out; }
        .message-wrapper.mine { align-self: flex-end; align-items: flex-end; }
        .message-wrapper.other { align-self: flex-start; align-items: flex-start; }
        .message-wrapper.system { align-self: center; max-width: 100%; }
        .message { padding: 0.75rem 1rem; border-radius: 18px; line-height: 1.5; white-space: pre-wrap; word-break: break-word; }
        .message-wrapper.mine .message { background-color: var(--my-message-color); color: #fff; border-bottom-right-radius: 4px; }
        .message-wrapper.other .message { background-color: var(--other-message-color); color: var(--text-color); border-bottom-left-radius: 4px; }
        .message-wrapper.system { color: var(--text-secondary-color); font-style: italic; font-size: 0.9em; text-align: center; width: 100%; }
        .message-meta { font-size: 0.8em; color: var(--text-secondary-color); margin-top: 4px; padding: 0 0.5rem; }
        .reply-context { background: rgba(0,0,0,0.2); padding: 5px 10px; margin-bottom: 5px; border-left: 3px solid var(--text-secondary-color); border-radius: 4px; font-size: 0.9em; }
        .reply-context strong { color: var(--my-message-color); }
        .reply-context blockquote { margin: 0; padding: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .media-container img, .media-container video { max-width: 100%; border-radius: 10px; margin-top: 5px; }
        .media-container audio { width: 100%; margin-top: 5px; }
        .file-link { margin-top: 5px; }
        .file-link a { color: #fff; text-decoration: underline; }

        /* --- Reply Preview & Form --- */
        #reply-preview { display: none; padding: 5px 15px; background: var(--chat-window-bg); border-top: 1px solid #333; flex-shrink: 0; }
        #reply-preview-content { background: var(--surface-color); border-left: 3px solid var(--my-message-color); padding: 5px 10px; border-radius: 4px; font-size: 0.9em; }
        #cancel-reply-btn { background: none; border: none; color: var(--text-secondary-color); cursor: pointer; float: right; }
        
        #typing-indicator-container { padding: 0 1.5rem 1rem 1.5rem; height: 24px; font-style: italic; color: var(--text-secondary-color); flex-shrink: 0; }
        #chat-form { display: flex; padding: 1rem; gap: 0.5rem; border-top: 1px solid #333; flex-shrink: 0; }
        #user-input { flex-grow: 1; padding: 0.75rem 1rem; font-size: 1rem; border-radius: 20px; border: 2px solid var(--chat-window-bg); background-color: var(--chat-window-bg); color: var(--text-color); }
        #user-input:focus { outline: none; border-color: var(--my-message-color); }
        .icon-btn { background: var(--my-message-color); border: none; border-radius: 50%; width: 50px; height: 50px; min-width: 50px; display: flex; justify-content: center; align-items: center; cursor: pointer; }
        .icon-btn:hover { background-color: #2563EB; }
        .icon-btn i, .icon-btn svg { font-size: 1.2rem; color: #fff; }
        .icon-btn svg { width: 24px; height: 24px; fill: #fff; }
    </style>
</head>
<body>
    <div id="welcome-screen">
        <div class="welcome-box">
            <h2>Welcome to Live Chat Pro</h2>
            <p>Please choose a unique username to join.</p>
            <form id="join-form">
                <input type="text" id="username-input" placeholder="Enter your username..." autocomplete="off" required maxlength="15">
                <button type="submit">Join Chat</button>
            </form>
            <div id="join-error-msg"></div>
        </div>
    </div>

    <div class="chat-container" id="chat-container">
        <header>
            <h1>𝐂𝐚𝐥𝐲𝐱 𝐃𝐫𝐞𝐲 𝐋𝐢𝐯𝐞 𝐂𝐡𝐚𝐭</h1>
            <div class="status-bar">Developed by <a href="#" target="_blank">𝐂𝐚𝐥𝐲𝐱 𝐃𝐫𝐞𝐲</a></div>
            <div id="user-list" title="Users currently online">Online: 0</div>
        </header>
        <div id="chat-window"></div>
        <div id="reply-preview">
            <div id="reply-preview-content">
                <button id="cancel-reply-btn"><i class="fa-solid fa-xmark"></i></button>
                <p>Replying to <strong id="reply-user"></strong></p>
                <blockquote id="reply-text"></blockquote>
            </div>
        </div>
        <div id="typing-indicator-container"></div>
        <form id="chat-form">
            <input type="file" id="file-input" style="display: none;" accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt,.zip">
            <label for="file-input" class="icon-btn" style="background-color: #4b5563;"><i class="fa-solid fa-paperclip"></i></label>
            <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off" required>
            <button type="submit" id="send-button" class="icon-btn" aria-label="Send Message">
                <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path></svg>
            </button>
        </form>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const socket = io();
            const welcomeScreen = document.getElementById('welcome-screen'), chatContainer = document.getElementById('chat-container'),
                  joinForm = document.getElementById('join-form'), usernameInput = document.getElementById('username-input'),
                  joinErrorMsg = document.getElementById('join-error-msg'), chatForm = document.getElementById('chat-form'),
                  userInput = document.getElementById('user-input'), chatWindow = document.getElementById('chat-window'),
                  userList = document.getElementById('user-list'), typingIndicator = document.getElementById('typing-indicator-container'),
                  fileInput = document.getElementById('file-input'), replyPreview = document.getElementById('reply-preview'),
                  cancelReplyBtn = document.getElementById('cancel-reply-btn');
            
            let typingTimeout, localUser = null, replyToMessage = null;
            let currentlyTyping = {};

            const addMessage = (msg) => {
                if (msg.type === 'system') {
                    const systemMsg = document.createElement('div');
                    systemMsg.className = 'message-wrapper system';
                    systemMsg.textContent = msg.content;
                    chatWindow.appendChild(systemMsg);
                } else {
                    const swipeContainer = document.createElement('div');
                    swipeContainer.className = 'message-swipe-container';
                    swipeContainer.dataset.messageId = msg.id;

                    const bg = document.createElement('div');
                    bg.className = 'swipe-background';
                    
                    const isMine = msg.user.id === localUser.id;
                    if (isMine) {
                        bg.classList.add('left');
                        bg.innerHTML = `<i class="fa-solid fa-trash-can"></i>`;
                    } else {
                        bg.classList.add('right');
                        bg.innerHTML = `<i class="fa-solid fa-reply"></i>`;
                    }
                    swipeContainer.appendChild(bg);

                    const wrapper = document.createElement('div');
                    wrapper.className = `message-wrapper ${isMine ? 'mine' : 'other'}`;
                    
                    let contentHTML = '';
                    if (msg.replyTo) {
                        contentHTML += `<div class="reply-context"><strong>${msg.replyTo.user}</strong><blockquote>${msg.replyTo.content}</blockquote></div>`;
                    }
                    if (msg.type === 'file') {
                        const filename = msg.content.split('/').pop().toLowerCase();
                        if (filename.match(/\.(jpeg|jpg|gif|png|svg)$/)) contentHTML += `<div class="media-container"><img src="${msg.content}"></div>`;
                        else if (filename.match(/\.(mp4|webm|ogg)$/)) contentHTML += `<div class="media-container"><video src="${msg.content}" controls></video></div>`;
                        else if (filename.match(/\.(mp3|wav|ogg)$/)) contentHTML += `<div class="media-container"><audio src="${msg.content}" controls></audio></div>`;
                        else contentHTML += `<div class="file-link"><a href="${msg.content}" target="_blank">Download: ${decodeURIComponent(filename.split('-').slice(1).join('-'))}</a></div>`;
                    } else {
                        contentHTML += `<p>${msg.content}</p>`;
                    }
                    
                    const time = new Date(msg.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    wrapper.innerHTML = `<div class="message">${contentHTML}</div><div class="message-meta">${isMine ? 'You' : msg.user.name} at ${time}</div>`;
                    
                    swipeContainer.appendChild(wrapper);
                    chatWindow.appendChild(swipeContainer);
                }
                scrollToBottom();
            };
            const scrollToBottom = () => chatWindow.scrollTop = chatWindow.scrollHeight;

            socket.on('join-success', ({user, history}) => {
                localUser = user;
                welcomeScreen.style.display = 'none';
                chatContainer.style.display = 'flex';
                history.forEach(addMessage);
            });
            socket.on('join-error', ({ message }) => joinErrorMsg.textContent = message);
            socket.on('system-message', (content) => addMessage({ type: 'system', content }));
            socket.on('chat message', addMessage);
            socket.on('message deleted', (messageId) => {
                const msgElement = document.querySelector(`.message-swipe-container[data-message-id='${messageId}']`);
                if (msgElement) msgElement.remove();
            });
            socket.on('update-users', ({ users }) => {
                const userNames = users.map(u => u.name).join(', ');
                userList.innerHTML = `Online (${users.length}): <span title="Users online: ${userNames}">${userNames}</span>`;
            });
            socket.on('typing-status', ({ user, isTyping }) => {
                if (isTyping) currentlyTyping[user.id] = user; else delete currentlyTyping[user.id];
                const typers = Object.values(currentlyTyping);
                if (typers.length === 0) typingIndicator.textContent = '';
                else if (typers.length === 1) typingIndicator.textContent = `${typers[0].name} is typing...`;
                else typingIndicator.textContent = `${typers.length} users are typing...`;
            });

            joinForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (usernameInput.value.trim()) socket.emit('join', usernameInput.value.trim());
            });
            
            chatForm.addEventListener('submit', (e) => {
                e.preventDefault();
                if (!userInput.value.trim()) return;
                socket.emit('chat message', { type: 'text', content: userInput.value, replyTo: replyToMessage });
                userInput.value = '';
                cancelReply();
                clearTimeout(typingTimeout);
                socket.emit('stop-typing');
            });

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const formData = new FormData();
                formData.append('file', file);
                fetch('/upload', { method: 'POST', body: formData })
                    .then(res => res.json())
                    .then(data => {
                        if (data.filePath) {
                            socket.emit('chat message', { type: 'file', content: data.filePath, replyTo: replyToMessage });
                            cancelReply();
                        } else alert('File upload failed.');
                    }).catch(err => alert('Upload error.'));
                fileInput.value = ''; // Reset input
            });

            let touchStartX = 0, touchCurrentX = 0, swipedElement = null, isMine;
            chatWindow.addEventListener('touchstart', (e) => {
                const target = e.target.closest('.message-wrapper');
                if (target) {
                    swipedElement = target;
                    isMine = target.classList.contains('mine');
                    touchStartX = e.touches[0].clientX;
                }
            }, { passive: true });
            
            chatWindow.addEventListener('touchmove', (e) => {
                if (!swipedElement) return;
                touchCurrentX = e.touches[0].clientX;
                let diffX = touchCurrentX - touchStartX;
                if ((isMine && diffX < 0 && diffX > -100) || (!isMine && diffX > 0 && diffX < 100)) {
                    swipedElement.style.transform = `translateX(${diffX}px)`;
                }
            }, { passive: true });

            chatWindow.addEventListener('touchend', (e) => {
                if (!swipedElement) return;
                const diffX = touchCurrentX - touchStartX;
                const messageId = parseInt(swipedElement.closest('.message-swipe-container').dataset.messageId);
                
                if (isMine && diffX < -60) socket.emit('delete message', messageId);
                else if (!isMine && diffX > 60) {
                    const user = swipedElement.querySelector('.message-meta').textContent.split(' at ')[0];
                    const content = swipedElement.querySelector('.message').textContent.trim().substring(0, 40) + '...';
                    replyToMessage = { id: messageId, user, content };
                    replyPreview.style.display = 'block';
                    document.getElementById('reply-user').textContent = user;
                    document.getElementById('reply-text').textContent = content;
                }
                swipedElement.style.transform = 'translateX(0)';
                swipedElement = null;
            });
            
            const cancelReply = () => {
                replyToMessage = null;
                replyPreview.style.display = 'none';
            }
            cancelReplyBtn.addEventListener('click', cancelReply);

            userInput.addEventListener('input', () => {
                clearTimeout(typingTimeout);
                socket.emit('typing');
                typingTimeout = setTimeout(() => socket.emit('stop-typing'), 1500);
            });
        });
    </script>
</body>
</html>